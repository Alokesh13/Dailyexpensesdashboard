<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ledger Luxe | Dual Budget Control</title>
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      color-scheme: dark;
      --slate-950: #030712;
      --accent-rose: #f472b6;
      --accent-blue: #60a5fa;
      --accent-amber: #facc15;
    }
    
    body {
      font-family: 'Space Grotesk', sans-serif;
      background: radial-gradient(circle at top, rgba(250, 204, 21, 0.08), transparent 60%),
                  radial-gradient(circle at 20% 20%, rgba(96, 165, 250, 0.08), transparent 45%),
                  #020617;
      color: #f8fafc;
    }
    
    .glass {
      background: linear-gradient(135deg, rgba(15, 23, 42, 0.85), rgba(15, 23, 42, 0.55));
      border: 1px solid rgba(148, 163, 184, 0.15);
      box-shadow: 0 10px 40px rgba(2, 6, 23, 0.65);
    }
    
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: rgba(15, 23, 42, 0.6); }
    ::-webkit-scrollbar-thumb { background: rgba(148, 163, 184, 0.5); border-radius: 999px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(248, 250, 252, 0.7); }
    
    .delete-btn {
      opacity: 0;
      transition: opacity 0.2s ease;
    }
    
    tr:hover .delete-btn {
      opacity: 1;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .nav-btn.active {
      background: rgba(255, 255, 255, 0.1);
      color: white;
    }
    
    .quick-add-form {
      transition: all 0.3s ease;
    }
    
    .quick-add-form:hover {
      transform: translateY(-2px);
    }
    
    .form-toggle {
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .form-toggle:hover {
      background: rgba(255, 255, 255, 0.05);
    }
  </style>
</head>
<body class="min-h-screen">
  <div class="min-h-screen flex flex-col lg:flex-row">
    <!-- Sidebar -->
    <aside class="w-full lg:w-72 glass px-6 py-8 flex flex-col gap-10">
      <div>
        <div class="flex items-center gap-3">
          <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-amber-400 to-pink-500 flex items-center justify-center text-2xl font-bold text-slate-950 shadow-lg">
            LL
          </div>
          <div>
            <p class="text-lg font-semibold tracking-tight">Ledger Luxe</p>
            <p class="text-xs text-slate-400 uppercase tracking-[0.3em]">Control Hub</p>
          </div>
        </div>
        <div class="mt-6 text-sm text-slate-400 leading-relaxed">
          Track personal and business cashflow, subscriptions, and dual budgets in one luxurious dashboard.
        </div>
      </div>

      <nav class="space-y-3 text-sm font-semibold">
        <button class="nav-btn w-full flex items-center justify-between px-4 py-3 rounded-2xl bg-white/5 text-white active" data-tab="overview">
          <span>Overview</span>
          <span class="text-xs text-emerald-300 bg-emerald-500/10 px-2 py-0.5 rounded-full">Live</span>
        </button>
        <button class="nav-btn w-full flex items-center justify-between px-4 py-3 rounded-2xl hover:bg-white/5 transition text-slate-400" data-tab="expenses">
          <span>Expenses</span>
          <span class="text-xs">⌘1</span>
        </button>
        <button class="nav-btn w-full flex items-center justify-between px-4 py-3 rounded-2xl hover:bg-white/5 transition text-slate-400" data-tab="subscriptions">
          <span>Subscriptions</span>
          <span class="text-xs">⌘2</span>
        </button>
        <button class="nav-btn w-full flex items-center justify-between px-4 py-3 rounded-2xl hover:bg-white/5 transition text-slate-400" data-tab="budgets">
          <span>Budgets</span>
          <span class="text-xs">⌘3</span>
        </button>
      </nav>

      <div class="mt-auto text-sm text-slate-400">
        <p class="text-slate-200 font-semibold mb-2">Storage</p>
        <div class="flex items-center justify-between text-xs mb-3">
          <span>Local data vault</span>
          <span id="last-updated" class="text-slate-300">--</span>
        </div>
        <div class="flex gap-2">
          <button id="reset-btn" class="flex-1 px-4 py-2 rounded-xl border border-white/10 text-xs tracking-wide uppercase text-rose-300 hover:bg-rose-500/10 transition">Reset & Seed Demo</button>
          <button id="export-btn" class="flex-1 px-4 py-2 rounded-xl border border-white/10 text-xs tracking-wide uppercase text-blue-300 hover:bg-blue-500/10 transition">Export to Sheets</button>
        </div>
      </div>
    </aside>

    <!-- Main Content Area -->
    <main class="flex-1 px-6 lg:px-10 py-8">
      <!-- Overview Tab -->
      <div id="overview" class="tab-content active space-y-10">
        <!-- Header -->
        <header class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
          <div>
            <p class="text-xs uppercase tracking-[0.4em] text-slate-400">Today · <span id="today-date">--</span></p>
            <h1 class="text-3xl md:text-4xl font-semibold tracking-tight mt-1">Dual Budget Command Console</h1>
          </div>
          <div class="flex items-center gap-3">
            <div class="px-4 py-2 rounded-xl bg-white/5 text-sm">
              Total Balance Watch · <span class="font-semibold text-emerald-300" id="total-left">$0.00</span> left
            </div>
            <button class="p-3 rounded-2xl bg-gradient-to-r from-purple-500 to-amber-400 text-slate-950 font-semibold shadow-lg shadow-amber-500/30 text-sm" id="quick-log">Quick Log</button>
          </div>
        </header>

        <!-- Quick Add Section -->
        <section class="grid gap-6 lg:grid-cols-2">
          <!-- Quick Add Expense -->
          <div class="glass rounded-3xl p-6 space-y-4 quick-add-form">
            <div class="flex items-center justify-between">
              <h3 class="text-xl font-semibold">Quick Add Expense</h3>
              <button class="form-toggle text-slate-400 hover:text-white p-2 rounded-xl" id="toggle-expense-form">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
              </button>
            </div>
            <form id="quick-expense-form" class="space-y-4 transition-all duration-300">
              <div class="grid gap-4 grid-cols-2">
                <label class="flex flex-col gap-1 text-sm">
                  <span class="text-xs text-slate-400">Description</span>
                  <input name="description" required placeholder="Lunch, supplies..." class="mt-1 bg-white/5 border border-white/10 rounded-xl px-3 py-2 text-sm focus:outline-none focus:border-rose-200">
                </label>
                <label class="flex flex-col gap-1 text-sm">
                  <span class="text-xs text-slate-400">Amount</span>
                  <input type="number" step="0.01" min="0" name="amount" required class="mt-1 bg-white/5 border border-white/10 rounded-xl px-3 py-2 text-sm focus:outline-none focus:border-rose-200">
                </label>
              </div>
              <div class="grid gap-4 grid-cols-2">
                <label class="flex flex-col gap-1 text-sm">
                  <span class="text-xs text-slate-400">Category</span>
                  <input name="category" placeholder="Food, Office..." class="mt-1 bg-white/5 border border-white/10 rounded-xl px-3 py-2 text-sm focus:outline-none focus:border-rose-200">
                </label>
                <label class="flex flex-col gap-1 text-sm">
                  <span class="text-xs text-slate-400">Scope</span>
                  <select name="scope" class="mt-1 bg-white/5 border border-white/10 rounded-xl px-3 py-2 text-sm focus:outline-none focus:border-rose-200" required>
                    <option value="personal">Personal</option>
                    <option value="business">Business</option>
                  </select>
                </label>
              </div>
              <button type="submit" class="w-full bg-gradient-to-r from-rose-400 to-amber-300 text-slate-900 font-semibold py-2 rounded-xl text-sm shadow-lg shadow-rose-500/30">Add Expense</button>
            </form>
          </div>

          <!-- Quick Budget Update -->
          <div class="glass rounded-3xl p-6 space-y-4 quick-add-form">
            <div class="flex items-center justify-between">
              <h3 class="text-xl font-semibold">Quick Budget Update</h3>
              <button class="form-toggle text-slate-400 hover:text-white p-2 rounded-xl" id="toggle-budget-form">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
              </button>
            </div>
            <form id="quick-budget-form" class="space-y-4 transition-all duration-300">
              <div class="grid gap-4 grid-cols-2">
                <label class="flex flex-col gap-1 text-sm">
                  <span class="text-xs text-slate-400">Scope</span>
                  <select name="scope" class="mt-1 bg-white/5 border border-white/10 rounded-xl px-3 py-2 text-sm focus:outline-none focus:border-emerald-200" required>
                    <option value="personal">Personal</option>
                    <option value="business">Business</option>
                  </select>
                </label>
                <label class="flex flex-col gap-1 text-sm">
                  <span class="text-xs text-slate-400">Amount</span>
                  <input type="number" step="0.01" min="0" name="amount" required class="mt-1 bg-white/5 border border-white/10 rounded-xl px-3 py-2 text-sm focus:outline-none focus:border-emerald-200">
                </label>
              </div>
              <button type="submit" class="w-full bg-gradient-to-r from-emerald-400 to-blue-500 text-slate-900 font-semibold py-2 rounded-xl text-sm shadow-lg shadow-emerald-500/30">Update Budget</button>
            </form>
          </div>
        </section>

        <!-- Highlights -->
        <section class="grid gap-6 lg:grid-cols-4">
          <div class="glass rounded-2xl p-5">
            <p class="text-xs uppercase tracking-[0.3em] text-slate-400">Personal Spend</p>
            <p class="text-3xl font-semibold mt-2" id="personal-spent">$0.00</p>
            <p class="text-emerald-300 text-sm mt-1" id="personal-count">0 entries</p>
          </div>
          <div class="glass rounded-2xl p-5">
            <p class="text-xs uppercase tracking-[0.3em] text-slate-400">Business Spend</p>
            <p class="text-3xl font-semibold mt-2" id="business-spent">$0.00</p>
            <p class="text-blue-300 text-sm mt-1" id="business-count">0 entries</p>
          </div>
          <div class="glass rounded-2xl p-5">
            <p class="text-xs uppercase tracking-[0.3em] text-slate-400">Subscriptions Active</p>
            <p class="text-3xl font-semibold mt-2" id="subscription-count">0</p>
            <p class="text-slate-300 text-sm mt-1" id="subscription-total">$0.00 / mo</p>
          </div>
          <div class="glass rounded-2xl p-5">
            <p class="text-xs uppercase tracking-[0.3em] text-slate-400">Total Burn</p>
            <p class="text-3xl font-semibold mt-2" id="total-spent">$0.00</p>
            <p class="text-slate-300 text-sm mt-1" id="burn-rate">—</p>
          </div>
        </section>

        <!-- Budget Status -->
        <section class="grid gap-6 xl:grid-cols-[1.1fr_0.9fr]">
          <div class="glass rounded-3xl p-6 space-y-6">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm uppercase tracking-[0.4em] text-slate-400">Budget Inputs</p>
                <h2 class="text-xl font-semibold">Personal vs Business allocations</h2>
              </div>
              <span class="text-xs text-slate-400">Autosave on apply</span>
            </div>
            <form id="budget-form" class="grid gap-4 md:grid-cols-2">
              <label class="flex flex-col gap-2">
                <span class="text-sm text-slate-300">Personal Budget (USD)</span>
                <input type="number" step="0.01" min="0" name="personalBudget" class="bg-white/5 border border-white/10 rounded-2xl px-4 py-3 focus:outline-none focus:border-amber-300/60" required>
              </label>
              <label class="flex flex-col gap-2">
                <span class="text-sm text-slate-300">Business Budget (USD)</span>
                <input type="number" step="0.01" min="0" name="businessBudget" class="bg-white/5 border border-white/10 rounded-2xl px-4 py-3 focus:outline-none focus:border-sky-300/60" required>
              </label>
              <button type="submit" class="md:col-span-2 bg-gradient-to-r from-emerald-400 to-blue-500 text-slate-900 font-semibold py-3 rounded-2xl shadow-lg shadow-emerald-500/30">Apply Budgets</button>
            </form>
          </div>
          <div class="glass rounded-3xl p-6 grid gap-6 text-sm">
            <div>
              <p class="text-slate-400 uppercase tracking-[0.4em] text-xs">Status</p>
              <h3 class="text-2xl font-semibold mt-2" id="status-balance">Calibrating…</h3>
              <p class="text-slate-400 mt-1">Real-time health of your dual portfolio.</p>
            </div>
            <div class="space-y-4">
              <div>
                <div class="flex items-center justify-between text-xs uppercase mb-1 text-slate-400">
                  <span>Personal Budget Used</span>
                  <span id="personal-percent">0%</span>
                </div>
                <div class="w-full h-2 rounded-full bg-white/5 overflow-hidden">
                  <div id="personal-bar" class="h-full bg-gradient-to-r from-rose-400 to-amber-300" style="width:0%"></div>
                </div>
              </div>
              <div>
                <div class="flex items-center justify-between text-xs uppercase mb-1 text-slate-400">
                  <span>Business Budget Used</span>
                  <span id="business-percent">0%</span>
                </div>
                <div class="w-full h-2 rounded-full bg-white/5 overflow-hidden">
                  <div id="business-bar" class="h-full bg-gradient-to-r from-sky-400 to-emerald-300" style="width:0%"></div>
                </div>
              </div>
            </div>
            <div class="grid grid-cols-2 gap-4 text-center">
              <div class="rounded-2xl bg-white/5 p-4">
                <p class="text-slate-400 text-xs uppercase tracking-[0.3em]">Personal left</p>
                <p class="text-xl font-semibold mt-1" id="personal-left">$0.00</p>
              </div>
              <div class="rounded-2xl bg-white/5 p-4">
                <p class="text-slate-400 text-xs uppercase tracking-[0.3em]">Business left</p>
                <p class="text-xl font-semibold mt-1" id="business-left">$0.00</p>
              </div>
            </div>
          </div>
        </section>

        <!-- Charts -->
        <section class="grid gap-6 xl:grid-cols-2">
          <div class="glass rounded-3xl p-6">
            <div class="flex items-center justify-between mb-6">
              <div>
                <p class="text-xs uppercase tracking-[0.3em] text-slate-400">Combined Overview</p>
                <h3 class="text-2xl font-semibold">Budget vs spent</h3>
              </div>
              <span class="text-xs text-slate-400">USD</span>
            </div>
            <div class="h-72">
              <canvas id="combinedChart"></canvas>
            </div>
          </div>
          <div class="grid gap-6">
            <div class="glass rounded-3xl p-6">
              <div class="flex items-center justify-between mb-6">
                <div>
                  <p class="text-xs uppercase tracking-[0.3em] text-slate-400">Personal Mix</p>
                  <h3 class="text-2xl font-semibold">Categories snapshot</h3>
                </div>
                <span class="text-emerald-300 text-sm" id="personal-mix-total">$0.00</span>
              </div>
              <div class="h-64">
                <canvas id="personalChart"></canvas>
              </div>
            </div>
            <div class="glass rounded-3xl p-6">
              <div class="flex items-center justify-between mb-6">
                <div>
                  <p class="text-xs uppercase tracking-[0.3em] text-slate-400">Business Mix</p>
                  <h3 class="text-2xl font-semibold">Categories snapshot</h3>
                </div>
                <span class="text-blue-300 text-sm" id="business-mix-total">$0.00</span>
              </div>
              <div class="h-64">
                <canvas id="businessChart"></canvas>
              </div>
            </div>
          </div>
        </section>

        <!-- Recent Activity -->
        <section class="grid gap-6 lg:grid-cols-2">
          <div class="glass rounded-3xl p-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-2xl font-semibold">Recent Expenses</h3>
              <span class="text-sm text-slate-400">Latest 5</span>
            </div>
            <div class="overflow-x-auto">
              <table class="w-full text-sm text-left">
                <thead class="text-slate-400 uppercase text-xs">
                  <tr>
                    <th class="py-2">Item</th>
                    <th class="py-2">Scope</th>
                    <th class="py-2">Category</th>
                    <th class="py-2 text-right">Amount</th>
                  </tr>
                </thead>
                <tbody id="recent-expense-table" class="divide-y divide-white/5"></tbody>
              </table>
            </div>
          </div>
          <div class="glass rounded-3xl p-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-2xl font-semibold">Upcoming Subscriptions</h3>
              <span class="text-sm text-slate-400">Next 5</span>
            </div>
            <div class="overflow-x-auto">
              <table class="w-full text-sm text-left">
                <thead class="text-slate-400 uppercase text-xs">
                  <tr>
                    <th class="py-2">Service</th>
                    <th class="py-2">Scope</th>
                    <th class="py-2">Billing</th>
                    <th class="py-2 text-right">Amount</th>
                  </tr>
                </thead>
                <tbody id="recent-subscription-table" class="divide-y divide-white/5"></tbody>
              </table>
            </div>
          </div>
        </section>
      </div>

      <!-- Expenses Tab -->
      <div id="expenses" class="tab-content space-y-10">
        <header class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
          <div>
            <p class="text-xs uppercase tracking-[0.4em] text-slate-400">Expense Management</p>
            <h1 class="text-3xl md:text-4xl font-semibold tracking-tight mt-1">Expense Ledger</h1>
          </div>
          <div class="flex items-center gap-3">
            <div class="px-4 py-2 rounded-xl bg-white/5 text-sm">
              Total Expenses · <span class="font-semibold text-rose-300" id="expenses-total">$0.00</span>
            </div>
          </div>
        </header>

        <section class="grid gap-6 lg:grid-cols-2">
          <div class="glass rounded-3xl p-6 space-y-4">
            <div>
              <p class="text-xs uppercase tracking-[0.3em] text-slate-400">Add Expense</p>
              <h3 class="text-2xl font-semibold">Log personal or business cost</h3>
            </div>
            <form id="expense-form" class="space-y-4">
              <div class="grid gap-4 sm:grid-cols-2">
                <label class="flex flex-col gap-1 text-sm">
                  Description
                  <input name="description" required placeholder="Dinner, ad spend…" class="mt-1 bg-white/5 border border-white/10 rounded-2xl px-4 py-3 focus:outline-none focus:border-rose-200">
                </label>
                <label class="flex flex-col gap-1 text-sm">
                  Amount
                  <input type="number" step="0.01" min="0" name="amount" required class="mt-1 bg-white/5 border border-white/10 rounded-2xl px-4 py-3 focus:outline-none focus:border-rose-200">
                </label>
              </div>
              <div class="grid gap-4 sm:grid-cols-2">
                <label class="flex flex-col gap-1 text-sm">
                  Category
                  <input name="category" placeholder="Food, SaaS, marketing" class="mt-1 bg-white/5 border border-white/10 rounded-2xl px-4 py-3 focus:outline-none focus:border-rose-200">
                </label>
                <label class="flex flex-col gap-1 text-sm">
                  Scope
                  <select name="scope" class="mt-1 bg-white/5 border border-white/10 rounded-2xl px-4 py-3 focus:outline-none focus:border-rose-200" required>
                    <option value="personal">Personal</option>
                    <option value="business">Business</option>
                  </select>
                </label>
              </div>
              <label class="flex flex-col gap-1 text-sm">
                Date
                <input type="date" name="date" data-today class="mt-1 bg-white/5 border border-white/10 rounded-2xl px-4 py-3 focus:outline-none focus:border-rose-200" required>
              </label>
              <button type="submit" class="w-full bg-gradient-to-r from-rose-400 via-amber-300 to-yellow-200 text-slate-900 font-semibold py-3 rounded-2xl shadow-lg shadow-rose-500/30">Add Expense</button>
            </form>
          </div>

          <div class="glass rounded-3xl p-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-2xl font-semibold">All Expenses</h3>
              <span class="text-sm text-slate-400" id="expense-count">0 entries</span>
            </div>
            <div class="overflow-x-auto max-h-[500px]">
              <table class="w-full text-sm text-left">
                <thead class="text-slate-400 uppercase text-xs sticky top-0 bg-slate-900/80 backdrop-blur">
                  <tr>
                    <th class="py-2">Item</th>
                    <th class="py-2">Scope</th>
                    <th class="py-2">Category</th>
                    <th class="py-2 text-right">Amount</th>
                    <th class="py-2 text-right">Actions</th>
                  </tr>
                </thead>
                <tbody id="expense-table" class="divide-y divide-white/5"></tbody>
              </table>
            </div>
          </div>
        </section>
      </div>

      <!-- Subscriptions Tab -->
      <div id="subscriptions" class="tab-content space-y-10">
        <header class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
          <div>
            <p class="text-xs uppercase tracking-[0.4em] text-slate-400">Subscription Management</p>
            <h1 class="text-3xl md:text-4xl font-semibold tracking-tight mt-1">Subscription Deck</h1>
          </div>
          <div class="flex items-center gap-3">
            <div class="px-4 py-2 rounded-xl bg-white/5 text-sm">
              Monthly Total · <span class="font-semibold text-blue-300" id="subscriptions-total">$0.00</span>
            </div>
          </div>
        </header>

        <section class="grid gap-6 lg:grid-cols-2">
          <div class="glass rounded-3xl p-6 space-y-4">
            <div>
              <p class="text-xs uppercase tracking-[0.3em] text-slate-400">Add Subscription</p>
              <h3 class="text-2xl font-semibold">Recurring tools & memberships</h3>
            </div>
            <form id="subscription-form" class="space-y-4">
              <div class="grid gap-4 sm:grid-cols-2">
                <label class="flex flex-col gap-1 text-sm">
                  Name
                  <input name="name" required placeholder="Notion, Canva Pro…" class="mt-1 bg-white/5 border border-white/10 rounded-2xl px-4 py-3 focus:outline-none focus:border-sky-200">
                </label>
                <label class="flex flex-col gap-1 text-sm">
                  Amount
                  <input type="number" step="0.01" min="0" name="amount" required class="mt-1 bg-white/5 border border-white/10 rounded-2xl px-4 py-3 focus:outline-none focus:border-sky-200">
                </label>
              </div>
              <div class="grid gap-4 sm:grid-cols-2">
                <label class="flex flex-col gap-1 text-sm">
                  Billing Cycle
                  <select name="billing" class="mt-1 bg-white/5 border border-white/10 rounded-2xl px-4 py-3 focus:outline-none focus:border-sky-200" required>
                    <option value="Monthly">Monthly</option>
                    <option value="Quarterly">Quarterly</option>
                    <option value="Annual">Annual</option>
                  </select>
                </label>
                <label class="flex flex-col gap-1 text-sm">
                  Scope
                  <select name="scope" class="mt-1 bg-white/5 border border-white/10 rounded-2xl px-4 py-3 focus:outline-none focus:border-sky-200" required>
                    <option value="personal">Personal</option>
                    <option value="business">Business</option>
                  </select>
                </label>
              </div>
              <label class="flex flex-col gap-1 text-sm">
                Next Charge Date
                <input type="date" name="date" data-today class="mt-1 bg-white/5 border border-white/10 rounded-2xl px-4 py-3 focus:outline-none focus:border-sky-200" required>
              </label>
              <button type="submit" class="w-full bg-gradient-to-r from-sky-400 via-violet-400 to-indigo-500 text-white font-semibold py-3 rounded-2xl shadow-lg shadow-sky-500/30">Add Subscription</button>
            </form>
          </div>

          <div class="glass rounded-3xl p-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-2xl font-semibold">All Subscriptions</h3>
              <span class="text-sm text-slate-400" id="subscription-page-count">0 entries</span>
            </div>
            <div class="overflow-x-auto max-h-[500px]">
              <table class="w-full text-sm text-left">
                <thead class="text-slate-400 uppercase text-xs sticky top-0 bg-slate-900/80 backdrop-blur">
                  <tr>
                    <th class="py-2">Service</th>
                    <th class="py-2">Scope</th>
                    <th class="py-2">Billing</th>
                    <th class="py-2 text-right">Amount</th>
                    <th class="py-2 text-right">Actions</th>
                  </tr>
                </thead>
                <tbody id="subscription-table" class="divide-y divide-white/5"></tbody>
              </table>
            </div>
          </div>
        </section>
      </div>

      <!-- Budgets Tab -->
      <div id="budgets" class="tab-content space-y-10">
        <header class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
          <div>
            <p class="text-xs uppercase tracking-[0.4em] text-slate-400">Budget Management</p>
            <h1 class="text-3xl md:text-4xl font-semibold tracking-tight mt-1">Budget Controls</h1>
          </div>
          <div class="flex items-center gap-3">
            <div class="px-4 py-2 rounded-xl bg-white/5 text-sm">
              Combined Budget · <span class="font-semibold text-emerald-300" id="combined-budget">$0.00</span>
            </div>
          </div>
        </header>

        <section class="grid gap-6 xl:grid-cols-[1.1fr_0.9fr]">
          <div class="glass rounded-3xl p-6 space-y-6">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm uppercase tracking-[0.4em] text-slate-400">Budget Inputs</p>
                <h2 class="text-xl font-semibold">Personal vs Business allocations</h2>
              </div>
              <span class="text-xs text-slate-400">Autosave on apply</span>
            </div>
            <form id="budgets-budget-form" class="grid gap-4 md:grid-cols-2">
              <label class="flex flex-col gap-2">
                <span class="text-sm text-slate-300">Personal Budget (USD)</span>
                <input type="number" step="0.01" min="0" name="personalBudget" class="bg-white/5 border border-white/10 rounded-2xl px-4 py-3 focus:outline-none focus:border-amber-300/60" required>
              </label>
              <label class="flex flex-col gap-2">
                <span class="text-sm text-slate-300">Business Budget (USD)</span>
                <input type="number" step="0.01" min="0" name="businessBudget" class="bg-white/5 border border-white/10 rounded-2xl px-4 py-3 focus:outline-none focus:border-sky-300/60" required>
              </label>
              <button type="submit" class="md:col-span-2 bg-gradient-to-r from-emerald-400 to-blue-500 text-slate-900 font-semibold py-3 rounded-2xl shadow-lg shadow-emerald-500/30">Apply Budgets</button>
            </form>
          </div>
          <div class="glass rounded-3xl p-6 grid gap-6 text-sm">
            <div>
              <p class="text-slate-400 uppercase tracking-[0.4em] text-xs">Status</p>
              <h3 class="text-2xl font-semibold mt-2" id="budgets-status-balance">Calibrating…</h3>
              <p class="text-slate-400 mt-1">Real-time health of your dual portfolio.</p>
            </div>
            <div class="space-y-4">
              <div>
                <div class="flex items-center justify-between text-xs uppercase mb-1 text-slate-400">
                  <span>Personal Budget Used</span>
                  <span id="budgets-personal-percent">0%</span>
                </div>
                <div class="w-full h-2 rounded-full bg-white/5 overflow-hidden">
                  <div id="budgets-personal-bar" class="h-full bg-gradient-to-r from-rose-400 to-amber-300" style="width:0%"></div>
                </div>
              </div>
              <div>
                <div class="flex items-center justify-between text-xs uppercase mb-1 text-slate-400">
                  <span>Business Budget Used</span>
                  <span id="budgets-business-percent">0%</span>
                </div>
                <div class="w-full h-2 rounded-full bg-white/5 overflow-hidden">
                  <div id="budgets-business-bar" class="h-full bg-gradient-to-r from-sky-400 to-emerald-300" style="width:0%"></div>
                </div>
              </div>
            </div>
            <div class="grid grid-cols-2 gap-4 text-center">
              <div class="rounded-2xl bg-white/5 p-4">
                <p class="text-slate-400 text-xs uppercase tracking-[0.3em]">Personal left</p>
                <p class="text-xl font-semibold mt-1" id="budgets-personal-left">$0.00</p>
              </div>
              <div class="rounded-2xl bg-white/5 p-4">
                <p class="text-slate-400 text-xs uppercase tracking-[0.3em]">Business left</p>
                <p class="text-xl font-semibold mt-1" id="budgets-business-left">$0.00</p>
              </div>
            </div>
          </div>
        </section>

        <section class="glass rounded-3xl p-6">
          <div class="flex items-center justify-between mb-6">
            <div>
              <p class="text-xs uppercase tracking-[0.3em] text-slate-400">Budget Analytics</p>
              <h3 class="text-2xl font-semibold">Budget vs spent overview</h3>
            </div>
            <span class="text-xs text-slate-400">USD</span>
          </div>
          <div class="h-72">
            <canvas id="budgets-combinedChart"></canvas>
          </div>
        </section>
      </div>
    </main>
  </div>

  <!-- Google Sheets Configuration Modal -->
  <div id="sheets-modal" class="fixed inset-0 bg-black/70 flex items-center justify-center z-50 hidden">
    <div class="glass rounded-3xl p-8 max-w-md w-full mx-4">
      <h3 class="text-2xl font-semibold mb-4">Google Sheets Setup</h3>
      <p class="text-slate-400 mb-6">Enter your Google Apps Script URL to enable data export.</p>
      <div class="space-y-4">
        <label class="flex flex-col gap-2">
          <span class="text-sm text-slate-300">Web App URL</span>
          <input type="url" id="sheets-url" class="bg-white/5 border border-white/10 rounded-2xl px-4 py-3 focus:outline-none focus:border-blue-300" placeholder="https://script.google.com/macros/s/...">
        </label>
        <div class="text-xs text-slate-500">
          <p>To set this up:</p>
          <ol class="list-decimal pl-5 mt-2 space-y-1">
            <li>Create a Google Apps Script</li>
            <li>Deploy it as a web app</li>
            <li>Set access to "Anyone"</li>
            <li>Paste the URL here</li>
          </ol>
        </div>
      </div>
      <div class="flex gap-3 mt-6">
        <button id="save-sheets" class="flex-1 bg-gradient-to-r from-blue-400 to-indigo-500 text-white font-semibold py-3 rounded-2xl">Save URL</button>
        <button id="close-sheets" class="flex-1 bg-white/10 text-slate-300 font-semibold py-3 rounded-2xl">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    const STORAGE_KEY = 'ledger_luxe_dual_budget_v4';
    const SHEETS_URL_KEY = 'ledger_luxe_sheets_url';
    
    const stateDefaults = {
      budgets: {
        personal: 2500,
        business: 4200
      },
      expenses: [
        { id: 1, description: 'Private chef tasting', amount: 280, category: 'Dining', scope: 'personal', date: new Date().toISOString() },
        { id: 2, description: 'Paid ads burst', amount: 950, category: 'Marketing', scope: 'business', date: new Date().toISOString() },
        { id: 3, description: 'Wellness membership', amount: 190, category: 'Health', scope: 'personal', date: new Date().toISOString() },
        { id: 4, description: 'Designer retainer', amount: 740, category: 'Creative', scope: 'business', date: new Date().toISOString() }
      ],
      subscriptions: [
        { id: 101, name: 'Canva Pro', amount: 14.99, billing: 'Monthly', scope: 'business', date: new Date().toISOString() },
        { id: 102, name: 'Headspace', amount: 12.99, billing: 'Monthly', scope: 'personal', date: new Date().toISOString() },
        { id: 103, name: 'Figma Organization', amount: 45, billing: 'Monthly', scope: 'business', date: new Date().toISOString() }
      ]
    };

    let state = structuredClone(stateDefaults);
    let combinedChart, personalChart, businessChart, budgetsCombinedChart;
    let sheetsUrl = localStorage.getItem(SHEETS_URL_KEY) || '';

    const formatCurrency = (val) => val.toLocaleString('en-US', { style: 'currency', currency: 'USD' });

    function saveState() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      document.getElementById('last-updated').textContent = new Date().toLocaleTimeString();
    }

    function loadState() {
      const saved = localStorage.getItem(STORAGE_KEY);
      if (saved) {
        state = JSON.parse(saved);
      } else {
        state = structuredClone(stateDefaults);
      }
    }

    function getScopeTotals(scope) {
      const expenseTotal = state.expenses.filter(e => e.scope === scope).reduce((sum, e) => sum + Number(e.amount), 0);
      const subTotal = state.subscriptions.filter(s => s.scope === scope).reduce((sum, s) => sum + Number(s.amount), 0);
      return expenseTotal + subTotal;
    }

    function renderHighlights() {
      const personalSpent = getScopeTotals('personal');
      const businessSpent = getScopeTotals('business');
      const totalSpent = personalSpent + businessSpent;
      const personalEntries = state.expenses.filter(e => e.scope === 'personal').length + state.subscriptions.filter(s => s.scope === 'personal').length;
      const businessEntries = state.expenses.filter(e => e.scope === 'business').length + state.subscriptions.filter(s => s.scope === 'business').length;

      document.getElementById('personal-spent').textContent = formatCurrency(personalSpent);
      document.getElementById('business-spent').textContent = formatCurrency(businessSpent);
      document.getElementById('total-spent').textContent = formatCurrency(totalSpent);
      document.getElementById('personal-count').textContent = `${personalEntries} entries`;
      document.getElementById('business-count').textContent = `${businessEntries} entries`;
      document.getElementById('subscription-count').textContent = state.subscriptions.length;
      const monthlySubs = state.subscriptions.reduce((sum, s) => sum + Number(s.amount), 0);
      document.getElementById('subscription-total').textContent = `${formatCurrency(monthlySubs)} / cycle`;
      document.getElementById('burn-rate').textContent = `${(totalSpent / (state.expenses.length + state.subscriptions.length || 1)).toFixed(2)} avg txn`;

      const personalPercent = state.budgets.personal ? Math.min((personalSpent / state.budgets.personal) * 100, 200) : 0;
      const businessPercent = state.budgets.business ? Math.min((businessSpent / state.budgets.business) * 100, 200) : 0;
      document.getElementById('personal-percent').textContent = `${personalPercent.toFixed(1)}%`;
      document.getElementById('business-percent').textContent = `${businessPercent.toFixed(1)}%`;
      document.getElementById('personal-bar').style.width = `${personalPercent}%`;
      document.getElementById('business-bar').style.width = `${businessPercent}%`;
      document.getElementById('personal-left').textContent = formatCurrency(Math.max(state.budgets.personal - personalSpent, 0));
      document.getElementById('business-left').textContent = formatCurrency(Math.max(state.budgets.business - businessSpent, 0));
      document.getElementById('total-left').textContent = formatCurrency(Math.max((state.budgets.personal + state.budgets.business) - totalSpent, 0));
      document.getElementById('status-balance').textContent = totalSpent > (state.budgets.personal + state.budgets.business) ? 'Overbudget – adjust now' : 'Healthy cash runway';

      // Update budget page elements
      document.getElementById('budgets-personal-percent').textContent = `${personalPercent.toFixed(1)}%`;
      document.getElementById('budgets-business-percent').textContent = `${businessPercent.toFixed(1)}%`;
      document.getElementById('budgets-personal-bar').style.width = `${personalPercent}%`;
      document.getElementById('budgets-business-bar').style.width = `${businessPercent}%`;
      document.getElementById('budgets-personal-left').textContent = formatCurrency(Math.max(state.budgets.personal - personalSpent, 0));
      document.getElementById('budgets-business-left').textContent = formatCurrency(Math.max(state.budgets.business - businessSpent, 0));
      document.getElementById('budgets-status-balance').textContent = totalSpent > (state.budgets.personal + state.budgets.business) ? 'Overbudget – adjust now' : 'Healthy cash runway';
      document.getElementById('combined-budget').textContent = formatCurrency(state.budgets.personal + state.budgets.business);
    }

    function renderTables() {
      // Recent expenses table (overview)
      const recentExpenseBody = document.getElementById('recent-expense-table');
      const recentExpenseRows = [...state.expenses]
        .sort((a, b) => new Date(b.date) - new Date(a.date))
        .slice(0, 5)
        .map(item => `
          <tr>
            <td class="py-3">
              <p class="font-semibold">${item.description}</p>
              <p class="text-xs text-slate-400">${new Date(item.date).toLocaleDateString()}</p>
            </td>
            <td class="py-3">
              <span class="px-2.5 py-1 rounded-full text-xs ${item.scope === 'personal' ? 'bg-rose-500/10 text-rose-200' : 'bg-sky-500/10 text-sky-200'}">${item.scope}</span>
            </td>
            <td class="py-3 text-slate-300">${item.category || '—'}</td>
            <td class="py-3 text-right font-semibold">${formatCurrency(Number(item.amount))}</td>
          </tr>
        `).join('');
      recentExpenseBody.innerHTML = recentExpenseRows || '<tr><td class="py-4 text-center text-slate-500" colspan="4">No expenses logged yet.</td></tr>';

      // Recent subscriptions table (overview)
      const recentSubBody = document.getElementById('recent-subscription-table');
      const recentSubRows = [...state.subscriptions]
        .sort((a, b) => new Date(a.date) - new Date(b.date))
        .slice(0, 5)
        .map(item => `
          <tr>
            <td class="py-3">
              <p class="font-semibold">${item.name}</p>
              <p class="text-xs text-slate-400">Next · ${new Date(item.date).toLocaleDateString()}</p>
            </td>
            <td class="py-3">
              <span class="px-2.5 py-1 rounded-full text-xs ${item.scope === 'personal' ? 'bg-emerald-500/10 text-emerald-200' : 'bg-indigo-500/10 text-indigo-200'}">${item.scope}</span>
            </td>
            <td class="py-3 text-slate-300">${item.billing}</td>
            <td class="py-3 text-right font-semibold">${formatCurrency(Number(item.amount))}</td>
          </tr>
        `).join('');
      recentSubBody.innerHTML = recentSubRows || '<tr><td class="py-4 text-center text-slate-500" colspan="4">No subscriptions on file.</td></tr>';

      // Full expense table (expenses page)
      const expenseBody = document.getElementById('expense-table');
      const expenseRows = [...state.expenses]
        .sort((a, b) => new Date(b.date) - new Date(a.date))
        .map(item => `
          <tr>
            <td class="py-3">
              <p class="font-semibold">${item.description}</p>
              <p class="text-xs text-slate-400">${new Date(item.date).toLocaleDateString()}</p>
            </td>
            <td class="py-3">
              <span class="px-2.5 py-1 rounded-full text-xs ${item.scope === 'personal' ? 'bg-rose-500/10 text-rose-200' : 'bg-sky-500/10 text-sky-200'}">${item.scope}</span>
            </td>
            <td class="py-3 text-slate-300">${item.category || '—'}</td>
            <td class="py-3 text-right font-semibold">${formatCurrency(Number(item.amount))}</td>
            <td class="py-3 text-right">
              <button class="delete-btn text-rose-400 hover:text-rose-300 transition" data-id="${item.id}" data-type="expense">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
              </button>
            </td>
          </tr>
        `).join('');
      expenseBody.innerHTML = expenseRows || '<tr><td class="py-4 text-center text-slate-500" colspan="5">No expenses logged yet.</td></tr>';
      document.getElementById('expense-count').textContent = `${state.expenses.length} entries`;
      document.getElementById('expenses-total').textContent = formatCurrency(state.expenses.reduce((sum, e) => sum + Number(e.amount), 0));

      // Full subscription table (subscriptions page)
      const subBody = document.getElementById('subscription-table');
      const subRows = [...state.subscriptions]
        .sort((a, b) => new Date(a.date) - new Date(b.date))
        .map(item => `
          <tr>
            <td class="py-3">
              <p class="font-semibold">${item.name}</p>
              <p class="text-xs text-slate-400">Next · ${new Date(item.date).toLocaleDateString()}</p>
            </td>
            <td class="py-3">
              <span class="px-2.5 py-1 rounded-full text-xs ${item.scope === 'personal' ? 'bg-emerald-500/10 text-emerald-200' : 'bg-indigo-500/10 text-indigo-200'}">${item.scope}</span>
            </td>
            <td class="py-3 text-slate-300">${item.billing}</td>
            <td class="py-3 text-right font-semibold">${formatCurrency(Number(item.amount))}</td>
            <td class="py-3 text-right">
              <button class="delete-btn text-rose-400 hover:text-rose-300 transition" data-id="${item.id}" data-type="subscription">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
              </button>
            </td>
          </tr>
        `).join('');
      subBody.innerHTML = subRows || '<tr><td class="py-4 text-center text-slate-500" colspan="5">No subscriptions on file.</td></tr>';
      document.getElementById('subscription-page-count').textContent = `${state.subscriptions.length} entries`;
      document.getElementById('subscriptions-total').textContent = formatCurrency(state.subscriptions.reduce((sum, s) => sum + Number(s.amount), 0));
    }

    function aggregateCategories(scope) {
      const bucket = {};
      state.expenses.filter(e => e.scope === scope).forEach(e => {
        const key = e.category || 'Uncategorized';
        bucket[key] = (bucket[key] || 0) + Number(e.amount);
      });
      state.subscriptions.filter(s => s.scope === scope).forEach(s => {
        const key = `${s.category || s.name}`;
        bucket[key] = (bucket[key] || 0) + Number(s.amount);
      });
      const entries = Object.entries(bucket);
      if (!entries.length) {
        return { labels: ['No data'], values: [1] };
      }
      return {
        labels: entries.map(([label]) => label),
        values: entries.map(([, value]) => value)
      };
    }

    function initCharts() {
      const combinedCtx = document.getElementById('combinedChart').getContext('2d');
      const personalCtx = document.getElementById('personalChart').getContext('2d');
      const businessCtx = document.getElementById('businessChart').getContext('2d');
      const budgetsCombinedCtx = document.getElementById('budgets-combinedChart').getContext('2d');

      combinedChart = new Chart(combinedCtx, {
        type: 'bar',
        data: {
          labels: ['Personal', 'Business'],
          datasets: [
            {
              label: 'Budget',
              data: [state.budgets.personal, state.budgets.business],
              backgroundColor: ['rgba(244, 114, 182, 0.3)', 'rgba(96, 165, 250, 0.3)'],
              borderColor: ['rgba(244, 114, 182, 1)', 'rgba(96, 165, 250, 1)'],
              borderWidth: 2
            },
            {
              label: 'Spent',
              data: [getScopeTotals('personal'), getScopeTotals('business')],
              backgroundColor: ['rgba(248, 250, 252, 0.9)', 'rgba(248, 250, 252, 0.9)'],
              borderRadius: 6
            },
            {
              label: 'Remaining',
              data: [Math.max(state.budgets.personal - getScopeTotals('personal'), 0), Math.max(state.budgets.business - getScopeTotals('business'), 0)],
              backgroundColor: ['rgba(16, 185, 129, 0.4)', 'rgba(34, 197, 94, 0.4)']
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              labels: { color: '#cbd5f5' }
            }
          },
          scales: {
            x: {
              ticks: { color: '#94a3b8' },
              grid: { display: false }
            },
            y: {
              ticks: {
                color: '#94a3b8',
                callback: value => '$' + value
              },
              grid: { color: 'rgba(148, 163, 184, 0.2)' }
            }
          }
        }
      });

      budgetsCombinedChart = new Chart(budgetsCombinedCtx, {
        type: 'bar',
        data: {
          labels: ['Personal', 'Business'],
          datasets: [
            {
              label: 'Budget',
              data: [state.budgets.personal, state.budgets.business],
              backgroundColor: ['rgba(244, 114, 182, 0.3)', 'rgba(96, 165, 250, 0.3)'],
              borderColor: ['rgba(244, 114, 182, 1)', 'rgba(96, 165, 250, 1)'],
              borderWidth: 2
            },
            {
              label: 'Spent',
              data: [getScopeTotals('personal'), getScopeTotals('business')],
              backgroundColor: ['rgba(248, 250, 252, 0.9)', 'rgba(248, 250, 252, 0.9)'],
              borderRadius: 6
            },
            {
              label: 'Remaining',
              data: [Math.max(state.budgets.personal - getScopeTotals('personal'), 0), Math.max(state.budgets.business - getScopeTotals('business'), 0)],
              backgroundColor: ['rgba(16, 185, 129, 0.4)', 'rgba(34, 197, 94, 0.4)']
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              labels: { color: '#cbd5f5' }
            }
          },
          scales: {
            x: {
              ticks: { color: '#94a3b8' },
              grid: { display: false }
            },
            y: {
              ticks: {
                color: '#94a3b8',
                callback: value => '$' + value
              },
              grid: { color: 'rgba(148, 163, 184, 0.2)' }
            }
          }
        }
      });

      const personalData = aggregateCategories('personal');
      personalChart = new Chart(personalCtx, {
        type: 'doughnut',
        data: {
          labels: personalData.labels,
          datasets: [{
            data: personalData.values,
            backgroundColor: personalData.labels.map((_, idx) => `hsla(${idx * 40}, 90%, 70%, 0.9)`),
            borderColor: '#0f172a'
          }]
        },
        options: {
          plugins: {
            legend: { labels: { color: '#cbd5f5', boxWidth: 12 } }
          }
        }
      });

      const businessData = aggregateCategories('business');
      businessChart = new Chart(businessCtx, {
        type: 'doughnut',
        data: {
          labels: businessData.labels,
          datasets: [{
            data: businessData.values,
            backgroundColor: businessData.labels.map((_, idx) => `hsla(${idx * 50 + 180}, 80%, 65%, 0.9)`),
            borderColor: '#0f172a'
          }]
        },
        options: {
          plugins: {
            legend: { labels: { color: '#cbd5f5', boxWidth: 12 } }
          }
        }
      });
    }

    function updateCharts() {
      if (!combinedChart) return;
      combinedChart.data.datasets[0].data = [state.budgets.personal, state.budgets.business];
      combinedChart.data.datasets[1].data = [getScopeTotals('personal'), getScopeTotals('business')];
      combinedChart.data.datasets[2].data = [Math.max(state.budgets.personal - getScopeTotals('personal'), 0), Math.max(state.budgets.business - getScopeTotals('business'), 0)];
      combinedChart.update();

      if (budgetsCombinedChart) {
        budgetsCombinedChart.data.datasets[0].data = [state.budgets.personal, state.budgets.business];
        budgetsCombinedChart.data.datasets[1].data = [getScopeTotals('personal'), getScopeTotals('business')];
        budgetsCombinedChart.data.datasets[2].data = [Math.max(state.budgets.personal - getScopeTotals('personal'), 0), Math.max(state.budgets.business - getScopeTotals('business'), 0)];
        budgetsCombinedChart.update();
      }

      const personalData = aggregateCategories('personal');
      personalChart.data.labels = personalData.labels;
      personalChart.data.datasets[0].data = personalData.values;
      personalChart.data.datasets[0].backgroundColor = personalData.labels.map((_, idx) => `hsla(${idx * 40}, 90%, 70%, 0.9)`);
      personalChart.update();

      const businessData = aggregateCategories('business');
      businessChart.data.labels = businessData.labels;
      businessChart.data.datasets[0].data = businessData.values;
      businessChart.data.datasets[0].backgroundColor = businessData.labels.map((_, idx) => `hsla(${idx * 50 + 180}, 80%, 65%, 0.9)`);
      businessChart.update();

      document.getElementById('personal-mix-total').textContent = formatCurrency(getScopeTotals('personal'));
      document.getElementById('business-mix-total').textContent = formatCurrency(getScopeTotals('business'));
    }

    function setTodayDefaults() {
      const today = new Date().toISOString().split('T')[0];
      document.querySelectorAll('[data-today]').forEach(input => {
        if (!input.value) input.value = today;
      });
      document.getElementById('today-date').textContent = new Date().toLocaleDateString(undefined, { weekday: 'long', month: 'long', day: 'numeric' });
    }

    function render() {
      renderHighlights();
      renderTables();
      updateCharts();
      document.querySelector('[name="personalBudget"]').value = state.budgets.personal;
      document.querySelector('[name="businessBudget"]').value = state.budgets.business;
      document.getElementById('budgets-budget-form').querySelector('[name="personalBudget"]').value = state.budgets.personal;
      document.getElementById('budgets-budget-form').querySelector('[name="businessBudget"]').value = state.budgets.business;
    }

    function exportToSheets() {
      if (!sheetsUrl) {
        document.getElementById('sheets-modal').classList.remove('hidden');
        return;
      }
      
      const data = {
        timestamp: new Date().toISOString(),
        budgets: state.budgets,
        expenses: state.expenses,
        subscriptions: state.subscriptions
      };
      
      fetch(sheetsUrl, {
        method: 'POST',
        mode: 'no-cors',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
      })
      .then(() => {
        alert('Data sent to Google Sheets successfully!');
      })
      .catch(err => {
        alert('Error sending data to Google Sheets. Check your URL and try again.');
        console.error('Sheets export error:', err);
      });
    }

    function switchTab(tabName) {
      // Hide all tab contents
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Show selected tab content
      document.getElementById(tabName).classList.add('active');
      
      // Update navigation buttons
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.remove('active', 'bg-white/5', 'text-white');
        btn.classList.add('text-slate-400');
      });
      
      // Activate current tab button
      document.querySelector(`.nav-btn[data-tab="${tabName}"]`).classList.add('active', 'bg-white/5', 'text-white');
      document.querySelector(`.nav-btn[data-tab="${tabName}"]`).classList.remove('text-slate-400');
    }

    function toggleForm(formId) {
      const form = document.getElementById(formId);
      form.classList.toggle('hidden');
    }

    // Event Listeners
    document.getElementById('budget-form').addEventListener('submit', (e) => {
      e.preventDefault();
      const form = e.target;
      state.budgets.personal = Number(form.personalBudget.value) || 0;
      state.budgets.business = Number(form.businessBudget.value) || 0;
      saveState();
      render();
    });

    document.getElementById('budgets-budget-form').addEventListener('submit', (e) => {
      e.preventDefault();
      const form = e.target;
      state.budgets.personal = Number(form.personalBudget.value) || 0;
      state.budgets.business = Number(form.businessBudget.value) || 0;
      saveState();
      render();
    });

    document.getElementById('expense-form').addEventListener('submit', (e) => {
      e.preventDefault();
      const data = new FormData(e.target);
      const newExpense = {
        id: crypto.randomUUID(),
        description: data.get('description'),
        amount: Number(data.get('amount')),
        category: data.get('category'),
        scope: data.get('scope'),
        date: data.get('date') || new Date().toISOString()
      };
      state.expenses.push(newExpense);
      saveState();
      render();
      e.target.reset();
      setTodayDefaults();
    });

    document.getElementById('subscription-form').addEventListener('submit', (e) => {
      e.preventDefault();
      const data = new FormData(e.target);
      const newSub = {
        id: crypto.randomUUID(),
        name: data.get('name'),
        amount: Number(data.get('amount')),
        billing: data.get('billing'),
        scope: data.get('scope'),
        date: data.get('date') || new Date().toISOString()
      };
      state.subscriptions.push(newSub);
      saveState();
      render();
      e.target.reset();
      setTodayDefaults();
    });

    // Quick Add Forms
    document.getElementById('quick-expense-form').addEventListener('submit', (e) => {
      e.preventDefault();
      const data = new FormData(e.target);
      const newExpense = {
        id: crypto.randomUUID(),
        description: data.get('description'),
        amount: Number(data.get('amount')),
        category: data.get('category'),
        scope: data.get('scope'),
        date: new Date().toISOString()
      };
      state.expenses.push(newExpense);
      saveState();
      render();
      e.target.reset();
      
      // Show success feedback
      const btn = e.target.querySelector('button[type="submit"]');
      const originalText = btn.textContent;
      btn.textContent = 'Added!';
      btn.classList.remove('from-rose-400', 'to-amber-300');
      btn.classList.add('from-emerald-400', 'to-emerald-500');
      setTimeout(() => {
        btn.textContent = originalText;
        btn.classList.remove('from-emerald-400', 'to-emerald-500');
        btn.classList.add('from-rose-400', 'to-amber-300');
      }, 1500);
    });

    document.getElementById('quick-budget-form').addEventListener('submit', (e) => {
      e.preventDefault();
      const data = new FormData(e.target);
      const scope = data.get('scope');
      const amount = Number(data.get('amount'));
      
      if (scope === 'personal') {
        state.budgets.personal = amount;
      } else {
        state.budgets.business = amount;
      }
      
      saveState();
      render();
      e.target.reset();
      
      // Show success feedback
      const btn = e.target.querySelector('button[type="submit"]');
      const originalText = btn.textContent;
      btn.textContent = 'Updated!';
      btn.classList.remove('from-emerald-400', 'to-blue-500');
      btn.classList.add('from-emerald-400', 'to-emerald-500');
      setTimeout(() => {
        btn.textContent = originalText;
        btn.classList.remove('from-emerald-400', 'to-emerald-500');
        btn.classList.add('from-emerald-400', 'to-blue-500');
      }, 1500);
    });

    document.addEventListener('click', (e) => {
      // Delete expense or subscription
      if (e.target.closest('.delete-btn')) {
        const btn = e.target.closest('.delete-btn');
        const id = btn.getAttribute('data-id');
        const type = btn.getAttribute('data-type');
        
        if (type === 'expense') {
          state.expenses = state.expenses.filter(item => item.id != id);
        } else if (type === 'subscription') {
          state.subscriptions = state.subscriptions.filter(item => item.id != id);
        }
        
        saveState();
        render();
      }
      
      // Tab navigation
      if (e.target.closest('.nav-btn')) {
        const btn = e.target.closest('.nav-btn');
        const tabName = btn.getAttribute('data-tab');
        switchTab(tabName);
      }
    });

    document.getElementById('reset-btn').addEventListener('click', () => {
      if (confirm('Reset all data and seed demo entries?')) {
        state = structuredClone(stateDefaults);
        saveState();
        render();
      }
    });

    document.getElementById('export-btn').addEventListener('click', exportToSheets);

    document.getElementById('quick-log').addEventListener('click', () => {
      const scope = prompt('Scope? personal / business');
      if (!scope || !['personal', 'business'].includes(scope.toLowerCase())) return;
      const amount = Number(prompt('Amount in USD?'));
      if (!amount) return;
      const description = prompt('Description?') || 'Quick log';
      state.expenses.push({
        id: crypto.randomUUID(),
        description,
        amount,
        category: 'Quick log',
        scope: scope.toLowerCase(),
        date: new Date().toISOString()
      });
      saveState();
      render();
    });

    // Google Sheets modal handlers
    document.getElementById('close-sheets').addEventListener('click', () => {
      document.getElementById('sheets-modal').classList.add('hidden');
    });

    document.getElementById('save-sheets').addEventListener('click', () => {
      sheetsUrl = document.getElementById('sheets-url').value;
      if (sheetsUrl) {
        localStorage.setItem(SHEETS_URL_KEY, sheetsUrl);
        document.getElementById('sheets-modal').classList.add('hidden');
        alert('Google Sheets URL saved successfully!');
      } else {
        alert('Please enter a valid URL');
      }
    });

    function init() {
      loadState();
      setTodayDefaults();
      initCharts();
      render();
      document.getElementById('last-updated').textContent = new Date().toLocaleTimeString();
      
      // Pre-fill sheets URL if available
      if (sheetsUrl) {
        document.getElementById('sheets-url').value = sheetsUrl;
      }
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
